!function(){"use strict";var a=angular.module("trackerApp",["ngRoute"]);a.config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"/partials/main",controller:"MainCtrl"}).when("/rides/new",{templateUrl:"/partials/ride_form",controller:"RideFormCtrl"}).when("/rides/:id",{templateUrl:"/partials/ride",controller:"RideCtrl"}).when("/rides/:id/edit",{templateUrl:"/partials/ride_form",controller:"RideFormCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}])}(),function(){"use strict";var a=angular.module("trackerApp");a.controller("MainCtrl",["$scope","rideStorage",function(a,b){b.get().then(function(b){a.rides=b})}])}(),function(){"use strict";var a=angular.module("trackerApp");a.controller("RideCtrl",["$scope","$route","$http","$window","$timeout","rideStorage",function(a,b,c,d,e,f){a.routeLoaded=!1,e(function(){d.location.reload(!0)},6e5),f.get(b.current.params.id).then(function(b){a.ride=b,g()});var g=function(){f.getTrack(a.ride).then(function(b){a.track=b,h()})},h=function(){f.getRoute(a.ride).then(function(b){a.route=b}).finally(function(){a.routeLoaded=!0})};a.uploadFile=function(b){var c=new FormData,d=new XMLHttpRequest,e=function(){4===d.readyState&&(204===d.status?h():console.log("Upload failed: ("+d.status+" "+d.statusText+") "+d.responseText))};c.append("file",b),d.addEventListener("readystatechange",e,!1),d.open("POST","/api/rides/"+a.ride.id+"/route"),d.send(c)}}])}(),function(){"use strict";var a=angular.module("trackerApp");a.controller("RideFormCtrl",["$scope","$route","$location","rideStorage",function(a,b,c,d){b.current.params.id?d.get(b.current.params.id).then(function(b){a.ride=b}):a.ride={},a.save=function(){a.ride.id?d.update(a.ride).then(function(){c.path("/rides/"+a.ride.id)}):d.create(a.ride).then(function(){c.path("/")})},a.destroy=function(){d.destroy(a.ride).then(function(){c.path("/")})}}])}(),function(){"use strict";var a=angular.module("trackerApp");a.factory("rideStorage",["$http","$q","$log",function(a,b,c){var d=function(){var d=b.defer();return a.get("/api/rides").then(function(a){d.resolve(a.data)}).catch(function(a){c.error("Failed to load rides"),c.error(a),d.reject(a)}),d.promise},e=function(d){var e=b.defer();return a.get("/api/rides/"+d).then(function(a){e.resolve(a.data)}).catch(function(a){c.error("Failed to load ride"),c.error(a),e.reject(a)}),e.promise},f=function(d){var e=b.defer();return a.post("/api/rides",{ride:d}).then(function(){e.resolve(d)}).catch(function(a){c.error("Failed to create ride"),c.error(a),e.reject(a)}),e.promise},g=function(d){var e=b.defer();return a.put("/api/rides/"+d.id,{ride:d}).then(function(){e.resolve(d)}).catch(function(a){c.error("Failed to update ride"),c.error(a),e.reject(a)}),e.promise},h=function(d){var e=b.defer();return a.delete("/api/rides/"+d.id).then(function(){e.resolve(d)}).catch(function(a){c.error("Failed to delete ride"),c.error(a),e.reject(a)}),e.promise},i=function(d){var e=b.defer();return a.get("/api/rides/"+d.id+"/route").then(function(a){e.resolve(a.data)}).catch(function(a){c.error("Failed to load route"),c.error(a),e.reject(a)}),e.promise},j=function(d){var e=b.defer();return a.get("/api/rides/"+d.id+"/track").then(function(a){e.resolve(a.data)}).catch(function(a){c.error("Failed to load track"),c.error(a),e.reject(a)}),e.promise};return{get:function(a){return angular.isDefined(a)?e(a):d()},create:f,update:g,destroy:h,getRoute:i,getTrack:j}}])}(),function(){"use strict";var a=angular.module("trackerApp");a.directive("fileChange",function(){return{link:function(a,b,c){b.on("change",function(){a.$apply(function(){a[c.fileChange](b[0].files[0])})})}}})}(),function(){"use strict";var a=angular.module("trackerApp"),b=function(a){var b=Number.NaN,c=Number.NaN,d=Number.NaN,e=Number.NaN;_.each(a,function(a){var f=parseFloat(a.latitude),g=parseFloat(a.longitude);(_.isNaN(b)||f>b)&&(b=f),(_.isNaN(c)||c>f)&&(c=f),(_.isNaN(d)||g>d)&&(d=g),(_.isNaN(e)||e>g)&&(e=g)});var f=(b+c)/2,g=(d+e)/2,h=new google.maps.LatLng(c,e),i=new google.maps.LatLng(b,d),j=new google.maps.LatLngBounds(h,i);return{centerLatitude:f,centerLongitude:g,bounds:j}},c=function(a){return{zoom:4,center:new google.maps.LatLng(a.centerLatitude,a.centerLongitude),mapTypeId:google.maps.MapTypeId.TERRAIN,keyboardShortcuts:!1}},d=function(a){return _.map(a,function(a){return new google.maps.LatLng(parseFloat(a.latitude),parseFloat(a.longitude))})},e=function(a,b,c){return new google.maps.Marker({flat:!0,map:a,icon:c,position:b})},f=function(a,b){b=d(b),new google.maps.Polyline({clickable:!1,map:a,path:b,strokeColor:"#ff0000"}),e(a,_.first(b),"http://www.google.com/mapfiles/dd-start.png"),e(a,_.last(b),"http://www.google.com/mapfiles/dd-end.png")},g=function(a,b){if(!_.isEmpty(b)){var c=d(b),f=new google.maps.InfoWindow,g=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/;new google.maps.Polyline({clickable:!1,map:a,path:c,strokeColor:"#0000ff"}),_.each(c,function(c,d){var h=e(a,c,"http://labs.google.com/ridefinder/images/mm_20_blue.png");c=b[d],google.maps.event.addListener(h,"click",function(){var b=c.dateTime.match(g),d=new Date(parseFloat(b[1]),parseFloat(b[2])-1,parseFloat(b[3]),parseFloat(b[4]),parseFloat(b[5]),parseFloat(b[6])),e=-1*d.getTimezoneOffset();d.addMinutes(e);var i='<table class="marker-data"><tbody><tr><td><b>Time:</b></td><td>'+d.toString("M/d/yyyy h:mm:ss tt")+"</td></tr><tr><td><b>Latitude:</b></td><td>"+c.latitude+"</td></tr><tr><td><b>Longitude:</b></td><td>"+c.longitude+"</td></tr></tbody></table>";f.close(),f.setContent(i),f.open(a,h)})}),google.maps.event.addListener(a,"click",function(){f.close()})}};a.directive("map",function(){return{scope:{routePoints:"=",trackPoints:"="},link:function(a,d){var e=b(a.routePoints),h=c(e),i=new google.maps.Map(d[0],h);i.fitBounds(e.bounds),d.addClass("map"),a.$watch("routePoints",function(){f(i,a.routePoints)}),a.$watch("trackPoints",function(){g(i,a.trackPoints)})}}})}();